---
import type { SiteMap } from '../data/siteMap';
import LogoSinFondo from '../icons/LogoSinFondo.svg'; 
import { getCollection } from 'astro:content';

interface Props {
  siteMap: SiteMap
}

const { siteMap } = Astro.props
const currentPath = Astro.url.pathname.replace(/\/$/, '')

const servicesCollection = await getCollection('services');

const servicesChildren = servicesCollection.map( service => ({
  url: `/servicios/${service.slug}`,
  label: service.data.navItem,
}));
if (siteMap.services) {
  siteMap.services.children = servicesChildren;
}
---

<div class="drawer z-50">
  <!-- Drawer toggle -->
  <input id="nav-drawer" type="checkbox" class="drawer-toggle" />

  <!-- Navbar (main content) -->
  <div class="drawer-content">
    <div class="navbar bg-base-100 shadow-sm">

      <!-- Left: logo -->
      <div class="navbar-start">
        <a href="/inicio">
          <LogoSinFondo class="w-24 h-auto md:w-36 xl:w-48" />
          <!--          <img src="/logoSinFondo.svg" alt="Logo de Reina Multiservicios" class="w-1/2" /> -->
        </a>
      </div>

      <!-- Center: desktop nav -->
      <div class="navbar-center hidden lg:flex">
        <ul class="menu menu-horizontal px-1">
          {Object.values(siteMap)
            .filter(page => page.label)
            .map(page => {
              if (page.children) {
                return (
                  <li>
                    <details>
                      <summary
                        class:list={{
                          'text-xl': true,
                          'active text-primary font-semibold': page.children.some(c => currentPath.startsWith(c.url)), 
                        }}
                      >{page.label}
                      </summary>
                      <ul class="p-2">
                        {page.children.map(child => (
                          <li class="text-xl">
                            <a
                              href={child.url}
                              class:list={{
                                'active text-primary font-semibold': currentPath === child.url,
                              }}
                            >
                              {child.label}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </details>
                  </li>
                )
              } else {
                return (
                  <li class="text-xl">
                    <a
                      href={page.url}
                      class:list={{
                        'active text-primary font-semibold': currentPath === page.url,
                      }}
                    >
                      {page.label}
                    </a>
                  </li>
                )
              }
            })}
        </ul>
      </div>

      <!-- Right: mobile hamburger -->
      <div class="navbar-end lg:hidden">
        <label for="nav-drawer" class="btn btn-ghost">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16" />
          </svg>
        </label>
      </div>
    </div>
  </div>

  <!-- Drawer side (mobile fullscreen modal) -->
  <div class="drawer-side bg-black/50 backdrop-blur-sm">
    <label for="nav-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
    <ul class="menu p-6 w-80 min-h-full bg-base-100 text-base-content">
      {Object.values(siteMap)
        .filter(page => page.label)
        .map(page => (
          <li>
            <a
              href={page.url}
              class="text-xl"
              class:list={{
                'active text-primary font-semibold': currentPath === page.url,
              }}
            >
              {page.label}
            </a>
            {page.children && (
              <ul>
                {page.children.map(child => (
                  <li>
                    <a
                      href={child.url}
                      class="text-lg"
                      class:list={{
                        'active text-primary font-semibold': currentPath === child.url,
                      }}
                    >
                      {child.label}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))}
    </ul>
  </div>
</div>

<!-- 4️⃣ Small script to auto-close <details> after navigation -->
<script>
  // Close any open <details> when navigating
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('details[open]').forEach(d => d.removeAttribute('open'))
  })
</script>

